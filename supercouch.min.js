/*!
 * SuperCouch
 * Copyright (c) 2012 Jake Luer <jake@qualiancy.com>
 * MIT Licensed
 *
 * @website http://supercou.ch
 * @issues https://github.com/qualiancy/supercouch/issues
 */
var supercouch=function(a,b){function d(a){return"[object Function]"===c.call(a)}function e(a){return a===Object(a)}function h(a,b){if(a&&b)for(var c in b)a[c]=b[c];return a}function i(a,b){if(a&&b)for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a}function j(a){a=a||{},this.reqOpts=a}function k(){var a=this.reqOpts;a.path.join("/").split("/").filter(function(a){return!a.trim.length});var b=a.path.length===1&&a.path[0]=="/"?"":a.path.join("/");return a.base+"/"+b}function l(a,b){"object"==typeof a&&(b=a,a="http://localhost:5984"),b=b||{},this.reqOpts={base:a||"http://localhost:5984"}}function m(a){a=a||{},this.reqOpts=a}a=function(a){return new l(a)},a.version="0.0.0";var c=Object.prototype.toString,f=Array.isArray||function(a){return"[object Array]"===c.call(a)},g=Array.prototype.indexOf||function(a,b){for(var c=b||0,d=this.length;c<d;c++)if(this[c]===a)return c;return-1};return j.prototype.end=function(a){var c=this,e=this.reqOpts,f=k.call(this),g=e.method.toUpperCase(),h;if("GET"===g)h=b.get(f);else if("POST"===g)h=b.post(f);else if("PUT"===g)h=b.put(f);else if("DELETE"===g)h=b.del(f);else{if("HEAD"!==g)return a(new Error("Unsuppored request method"));h=b.head(f)}e.body&&h.send(e.body),h.end(function(c){var f,h=null;if(g==="HEAD"){var i=e.validate?e.validate(c):c.status!==404;return a(null,i)}try{f=JSON.parse(c.text)}catch(j){h=j}!h&&f.error&&(h=f);if(h)return a(h);var i=d(e.validate)?e.validate(f):f;a(null,i)})},l.prototype.request=function(a,b,c){var e=h({method:a,path:[b]},this.reqOpts),f=new j(e);return d(c)&&f.end(c),f},l.prototype.action=function(a,b,c){var e={"all dbs":"GET","active tasks":"GET",uuids:"GET",stats:"GET",log:"GET",replicate:"POST",restart:"POST"};if(!e[a])throw new Error("Couch action `"+a+"` not valid");d(b)&&(c=b,data={});var f=e[a],g="_"+a.split(" ").join("_"),i=h({method:f,path:[g],body:b},this.reqOpts),k=new j(i);return d(c)&&k.end(c),k},l.prototype.dbAdd=function(a,b){var c=h({method:"PUT",path:[a]},this.reqOpts),e=new j(c);return d(b)&&e.end(b),e},l.prototype.dbInfo=function(a,b){var c=h({method:"GET",path:[a]},this.reqOpts),e=new j(c);return d(b)&&e.end(b),e},l.prototype.dbExists=function(a,b){var c=h({method:"GET",path:["_all_dbs"],validate:function(b){return g.call(b,a)>-1}},this.reqOpts),e=new j(c);return d(b)&&e.end(b),e},l.prototype.dbDel=function(a,b){var c=h({method:"DELETE",path:[a]},this.reqOpts),e=new j(c);return d(b)&&e.end(b),e},l.prototype.db=function(a){var b=h({path:[a]},this.reqOpts),c=new m(b);return c},m.prototype.action=function(a,b,c){var e={changes:"GET",compact:"POST","view cleanup":"POST","temp view":"POST","ensure full commit":"POST",purge:"POST"};if(!e[a])throw new Error("Couch action `"+a+"` not valid");d(b)&&(c=b,data={});var f=e[a],g="_"+a.split(" ").join("_"),i=h({method:f,body:b},this.reqOpts);i.path.push(g);var k=new j(i);return d(c)&&k.end(c),k},m.prototype.insert=function(a,b){d(a)&&(b=a,a={});var c=h({method:a._id?"PUT":"POST",body:a},this.reqOpts);a._id&&c.path.push(a._id);var e=new j(c);return d(b)&&e.end(b),e},m.prototype.get=function(a,b,c){d(b)&&(c=b,b=null);var e=h({method:"GET"},this.reqOpts);e.path.push(a),b&&(e.qs=[{rev:b}]);var f=new j(e);return d(c)&&f.end(c),f},m.prototype.update=function(a,b,c,f){e(b)&&(f=c,c=b,b=null);var g=h({method:"PUT",body:c},this.reqOpts);g.path.push(a),b&&(g.qs=[{rev:b}]);var i=new j(g);return d(f)&&i.end(f),i},a}({},superagent)