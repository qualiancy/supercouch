/*!
 * SuperCouch
 * Copyright (c) 2012 Jake Luer <jake@qualiancy.com>
 * MIT Licensed
 *
 * @website http://supercou.ch
 * @issues https://github.com/qualiancy/supercouch/issues
 */
var supercouch=function(a,b){function d(a){return"[object Function]"===c.call(a)}function e(a){return a===Object(a)}function g(a,b){if(a&&b)for(var c in b)a[c]=b[c];return a}function h(a,b){if(a&&b)for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a}function i(a){a=a||{},this.reqOpts=a}function j(){var a=this.reqOpts;a.path.join("/").split("/").filter(function(a){return!a.trim.length});var b=a.path.length===1&&a.path[0]=="/"?"":a.path.join("/");return a.base+"/"+b}function k(a,b){"object"==typeof a&&(b=a,a="http://localhost:5984"),b=b||{},this.reqOpts={base:a||"http://localhost:5984"}}function l(a){a=a||{},this.reqOpts=a}a=function(a){return new k(a)},a.version="0.0.0";var c=Object.prototype.toString,f=Array.isArray||function(a){return"[object Array]"===c.call(a)};return i.prototype.end=function(a){var c=this,e=this.reqOpts,f=j.call(this),g=e.method.toUpperCase(),h;if("GET"===g)h=b.get(f);else if("POST"===g)h=b.post(f);else if("PUT"===g)h=b.put(f);else if("DELETE"===g)h=b.del(f);else{if("HEAD"!==g)return a(new Error("Unsuppored request method"));h=b.head(f)}e.body&&h.send(e.body),h.end(function(c){var f,h=null;if(g==="HEAD"){var i=e.validate?e.validate(c):c.status!==404;return a(null,i)}try{f=JSON.parse(c.text)}catch(j){h=j}!h&&f.error&&(h=f);if(h)return a(h);var i=d(e.validate)?e.validate(f):f;a(null,i)})},k.prototype.request=function(a,b,c){var e=g({method:a,path:[b]},this.reqOpts),f=new i(e);return d(c)&&f.end(c),f},k.prototype.action=function(a,b,c){var e={"all dbs":"GET","active tasks":"GET",uuids:"GET",stats:"GET",log:"GET",replicate:"POST",restart:"POST"};if(!e[a])throw new Error("Couch action `"+a+"` not valid");d(b)&&(c=b,data={});var f=e[a],h="_"+a.split(" ").join("_"),j=g({method:f,path:[h],body:b},this.reqOpts),k=new i(j);return d(c)&&k.end(c),k},k.prototype.dbAdd=function(a,b){var c=g({method:"PUT",path:[a]},this.reqOpts),e=new i(c);return d(b)&&e.end(b),e},k.prototype.dbInfo=function(a,b){var c=g({method:"GET",path:[a]},this.reqOpts),e=new i(c);return d(b)&&e.end(b),e},k.prototype.dbExists=function(a,b){var c=g({method:"GET",path:["_all_dbs"],validate:function(b){return b.indexOf(a)>-1}},this.reqOpts),e=new i(c);return d(b)&&e.end(b),e},k.prototype.dbDel=function(a,b){var c=g({method:"DELETE",path:[a]},this.reqOpts),e=new i(c);return d(b)&&e.end(b),e},k.prototype.db=function(a){var b=g({path:[a]},this.reqOpts),c=new l(b);return c},l.prototype.action=function(a,b,c){var e={changes:"GET",compact:"POST","view cleanup":"POST","temp view":"POST","ensure full commit":"POST",purge:"POST"};if(!e[a])throw new Error("Couch action `"+a+"` not valid");d(b)&&(c=b,data={});var f=e[a],h="_"+a.split(" ").join("_"),j=g({method:f,body:b},this.reqOpts);j.path.push(h);var k=new i(j);return d(c)&&k.end(c),k},l.prototype.insert=function(a,b){d(a)&&(b=a,a={});var c=g({method:a._id?"PUT":"POST",body:a},this.reqOpts);a._id&&c.path.push(a._id);var e=new i(c);return d(b)&&e.end(b),e},l.prototype.get=function(a,b,c){d(b)&&(c=b,b=null);var e=g({method:"GET"},this.reqOpts);e.path.push(a),b&&(e.qs=[{rev:b}]);var f=new i(e);return d(c)&&f.end(c),f},l.prototype.update=function(a,b,c,f){e(b)&&(f=c,c=b,b=null);var h=g({method:"PUT",body:c},this.reqOpts);h.path.push(a),b&&(h.qs=[{rev:b}]);var j=new i(h);return d(f)&&j.end(f),j},a}({},superagent)